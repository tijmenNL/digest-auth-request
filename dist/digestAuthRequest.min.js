!function(e,t){"function"==typeof define&&define.amd?define(["crypto-js"],t):"object"==typeof exports?module.exports=t(require("crypto-js")):e.digestAuthRequest=t(e.crypto-js)}(this,function(e){return function(e,t,s,n){var u=this;if(void 0===o&&"function"==typeof require)var o=require("crypto-js");this.scheme=null,this.nonce=null,this.realm=null,this.qop=null,this.response=null,this.opaque=null,this.nc=1,this.cnonce=null,this.timeout=1e4,this.loggingOn=!0,this.post=!1,"post"!==e.toLowerCase()&&"put"!==e.toLowerCase()||(this.post=!0),this.request=function(e,t,s){s&&(u.data=JSON.stringify(s)),u.successFn=e,u.errorFn=t,u.nonce?u.makeAuthenticatedRequest():u.makeUnauthenticatedRequest(u.data)},this.makeUnauthenticatedRequest=function(s){u.firstRequest=new XMLHttpRequest,u.firstRequest.open(e,t,!0),u.firstRequest.timeout=u.timeout,u.post&&u.firstRequest.setRequestHeader("Content-type","application/json"),u.firstRequest.onreadystatechange=function(){if(2===u.firstRequest.readyState){var e,s=u.firstRequest.getAllResponseHeaders();s=s.split("\n");for(var n=0;n<s.length;n++)if(null!=s[n].match(/^www-authenticate:/i)){e=s[n];break}if(null!=e){for(e=(e=e.slice(e.indexOf(":")+1,-1)).split(","),u.scheme=e[0].split(/\s/)[1],n=0;n<e.length;n++){var o=e[n].indexOf("="),a=e[n].substring(0,o),r=e[n].substring(o+1);r=r.replace(/['"]+/g,""),null!=a.match(/realm/i)&&(u.realm=r),null!=a.match(/nonce/i)&&(u.nonce=r),null!=a.match(/opaque/i)&&(u.opaque=r),null!=a.match(/qop/i)&&(u.qop=r)}u.cnonce=u.generateCnonce(),u.nc++,u.log("received headers:"),u.log("\trealm: "+u.realm),u.log("\tnonce: "+u.nonce),u.log("\topaque: "+u.opaque),u.log("\tqop: "+u.qop),u.makeAuthenticatedRequest()}}4===u.firstRequest.readyState&&200===u.firstRequest.status&&(u.log("Authentication not required for "+t),"undefined"!==u.firstRequest.responseText?u.firstRequest.responseText.length>0&&(u.isJson(u.firstRequest.responseText)?u.successFn(JSON.parse(u.firstRequest.responseText)):u.successFn(u.firstRequest.responseText)):u.successFn())},u.post?u.firstRequest.send(u.data):u.firstRequest.send(),u.log("Unauthenticated request to "+t),u.firstRequest.onerror=function(){401!==u.firstRequest.status&&(u.log("Error ("+u.firstRequest.status+") on unauthenticated request to "+t),u.errorFn(u.firstRequest.status))}},this.makeAuthenticatedRequest=function(){u.response=u.formulateResponse(),u.authenticatedRequest=new XMLHttpRequest,u.authenticatedRequest.open(e,t,!0),u.authenticatedRequest.timeout=u.timeout;var n=u.scheme+' username="'+s+'", realm="'+u.realm+'", nonce="'+u.nonce+'", uri="'+t+'", response="'+u.response+'", opaque="'+u.opaque+'", qop='+u.qop+", nc="+("00000000"+u.nc).slice(-8)+', cnonce="'+u.cnonce+'"';u.authenticatedRequest.setRequestHeader("Authorization",n),u.log("digest auth header response to be sent:"),u.log(n),u.post&&u.authenticatedRequest.setRequestHeader("Content-type","application/json"),u.authenticatedRequest.onload=function(){u.authenticatedRequest.status>=200&&u.authenticatedRequest.status<400?(u.nc++,"undefined"!==u.authenticatedRequest.responseText&&u.authenticatedRequest.responseText.length>0?u.isJson(u.authenticatedRequest.responseText)?u.successFn(JSON.parse(u.authenticatedRequest.responseText)):u.successFn(u.authenticatedRequest.responseText):u.successFn()):(u.nonce=null,u.errorFn(u.authenticatedRequest.status))},u.authenticatedRequest.onerror=function(){u.log("Error ("+u.authenticatedRequest.status+") on authenticated request to "+t),u.nonce=null,u.errorFn(u.authenticatedRequest.status)},u.post?u.authenticatedRequest.send(u.data):u.authenticatedRequest.send(),u.log("Authenticated request to "+t)},this.formulateResponse=function(){var a=o.MD5(s+":"+u.realm+":"+n).toString(),r=o.MD5(e+":"+t).toString();return o.MD5(a+":"+u.nonce+":"+("00000000"+u.nc).slice(-8)+":"+u.cnonce+":"+u.qop+":"+r).toString()},this.generateCnonce=function(){for(var e="abcdef0123456789",t="",s=0;s<16;s++){var n=Math.round(Math.random()*e.length);t+=e.substr(n,1)}return t},this.abort=function(){u.log("[digestAuthRequest] Aborted request to "+t),null!=u.firstRequest&&4!=u.firstRequest.readyState&&u.firstRequest.abort(),null!=u.authenticatedRequest&&4!=u.authenticatedRequest.readyState&&u.authenticatedRequest.abort()},this.isJson=function(e){try{JSON.parse(e)}catch(e){return!1}return!0},this.log=function(e){u.loggingOn&&console.log("[digestAuthRequest] "+e)},this.version=function(){return"0.8.0"}}});